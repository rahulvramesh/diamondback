<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Diamondback</title>
	<link rel="shortcut icon" type="image/png" href="/media/images/favicon.png">
	<link rel="stylesheet" type="text/css" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.10/css/dataTables.bootstrap.min.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css">

    
	<style type="text/css" class="init">
		#tabs { 
    padding: 0px; 
    background: none; 
    border-width: 0px; 
} 
#tabs .ui-tabs-nav { 
    padding-left: 0px; 
    background: transparent; 
    border-width: 0px 0px 1px 0px; 
    -moz-border-radius: 0px; 
    -webkit-border-radius: 0px; 
    border-radius: 0px; 
} 
#tabs .ui-tabs-panel { 
  
  
    border-width: 0px 1px 1px 1px; 
}
        
        .ui-widget-content{
          background:white !important;
        }
        
        form { display: block; margin: 20px auto; background: #eee; border-radius: 10px; padding: 15px }

.progress { position:relative; width:400px; border: 1px solid #ddd; padding: 1px; border-radius: 3px; }
.bar { background-color: #B4F5B4; width:0%; height:20px; border-radius: 3px; }
.percent { position:absolute; display:inline-block; top:3px; left:48%; }
        

/* Start by setting display:none to make this hidden.
   Then we position it in relation to the viewport window
   with position:fixed. Width, height, top and left speak
   for themselves. Background we set to 80% white with
   our animation centered, and no-repeating */
.modal {
    display:    none;
    position:   fixed;
    z-index:    1000;
    top:        0;
    left:       0;
    height:     100%;
    width:      100%;
    background: rgba( 255, 255, 255, .8 ) 
                url('http://i.stack.imgur.com/FhHRx.gif') 
                50% 50% 
                no-repeat;
}

/* When the body has the loading class, we turn
   the scrollbar off with overflow:hidden */
body.loading {
    overflow: hidden;   
}

/* Anytime the body has the loading class, our
   modal element will be visible */
body.loading .modal {
    display: block;
}

        
	</style>
        

 <link href="http://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css" rel="stylesheet">
      <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
     
      
	
	
	<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js">
	</script>
	<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.10/js/dataTables.bootstrap.min.js">
	</script>
<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

<script src="https://sdk.amazonaws.com/js/aws-sdk-2.2.21.min.js"></script>
    <script src="http://malsup.github.com/jquery.form.js"></script>
    
    
	<script type="text/javascript" class="init">
var dialog;



$( document ).ready(function() {
	 $body = $("body");

    $(document).on({
        ajaxStart: function() { $body.addClass("loading");    },
         ajaxStop: function() { $body.removeClass("loading"); }    
    });
    
    
    $( "#fromdate" ).datepicker();
    $( "#todate" ).datepicker();
    document.getElementById("uploader").innerHTML='<object type="text/html" height="100%" width="100%" data="http://ec2contai-ecselast-1odt0hji1ptrd-903851155.us-west-1.elb.amazonaws.com/etl" ></object>';
    
});
        
        
        


$(function() {


    $( "#myTabs" ).tabs();
    populateSchedule();
    populateCron();
    
});
        
   
       
        
        
        
        
        
    var dialog;    
$(function() {
    var form,
 
      // From http://www.whatwg.org/specs/web-apps/current-work/multipage/states-of-the-type-attribute.html#e-mail-state-%28type=email%29
      emailRegex = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/,
      name = $( "#name" ),
      email = $( "#email" ),
      password = $( "#password" ),
      allFields = $( [] ).add( name ).add( email ).add( password ),
      tips = $( ".validateTips" );
 
    function updateTips( t ) {
      tips
        .text( t )
        .addClass( "ui-state-highlight" );
      setTimeout(function() {
        tips.removeClass( "ui-state-highlight", 1500 );
      }, 500 );
    }
 
    
 
    function checkRegexp( o, regexp, n ) {
      if ( !( regexp.test( o.val() ) ) ) {
        o.addClass( "ui-state-error" );
        updateTips( n );
        return false;
      } else {
        return true;
      }
    }
 
    
 
    dialog = $( "#dialog-form" ).dialog({
      autoOpen: false,
      height: 500,
      width: 600,
      modal: true,    
      
    });
 
    
 
    $( "#create-user" ).button().on( "click", function() {
      dialog.dialog( "open" );
    });
  });        
        
        

var processSearch = function(){
    
    
    
    var data = "{\"hospital\":\""+$("#hospital").val() + "\",\"workstation\":\"" + $("#workstation").val()+"\",\"procedureId\":\""+$("#procid").val()+"\",\"fromDate\":\""+$("#fromdate").val()+"\",\"toDate\":\""+$("#todate").val()+"\"}";
    
  
   $.ajax({
        type: "POST",
        url: "/diamondback/app/search",
        data: data,
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(fdata){processTable(fdata);}, 
        failure: function(errMsg) {
            alert(errMsg);
        }
  });
}
var table;
var table4script;
var selectedProcedure;        
var selected = [];  
function processTable(fdata){
    selected = [];
    if(fdata.data.length==0){
        alert("No data found for your query");
        
    }
    if(table){
        table.destroy();
    }
 
 table = $('#example').DataTable( {
  			aaData: fdata.data,
            "columnDefs": [ {
            "targets": -1,
            "data": null,
            "defaultContent": "<button id='download'>Download!</button>"
        }]
      
            
		} );
    
    $('#example tbody').on('click', 'tr', function () {
        
        var data = table.row( $(this) ).data();
        
        var index = $.inArray(data[4], selected);
 
        if ( index === -1 ) {
            selected.push( data[4] );
        } else {
            selected.splice( data[4], 1 );
        }
       
 
        $(this).toggleClass('selected');
    } );
    
     $('#example tbody').on( 'click', '#download', function () {
        var data = table.row( $(this).parents('tr') ).data();
        //alert(data[4]);
        location.href = "/diamondback/app/download/"+data[4]; 
    } );
    
  

}
        
function executeScript(){

        if(selected.length == 0){
            alert("Please execute the query and select a row");
            return;
        }
        loadTable();
         dialog.dialog( "open" );

}

function loadTable(){

$.ajax({
        type: "GET",
        url: "/diamondback/app/list/script",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(fdata){porcessScriptTable(fdata.data);}, 
        failure: function(errMsg) {
            alert(errMsg);
        }
      });


}
var scheduleTable;
function porcessScriptTable(data){
   
		if(table4script){
            table4script.destroy();
        }
         table4script = $('#scriptTable').DataTable( {
  			aaData: data,
            "columnDefs": [ {
            "targets": -1,
            "data": null,
            "defaultContent": "<button id='sExecute'>Execute!</button>"
            } ]
         });
    
    $('#scriptTable tbody').on( 'click', '#sExecute', function () {
		        var data = table4script.row( $(this).parents('tr') ).data();
		        
		        saveSchedule(data,selected);
                 dialog.dialog( "close" );
        
                
                 $('#ui-id-3').click();
                 
                 setTimeout(
			            'populateSchedule();',
			            500
			        );
			                 
                 
        
        
        
    	    
    	} );


}

function saveSchedule(scriptName,fileName){
    
var scheduleData = "{\"scriptName\":\""+scriptName + "\",\"fileName\":\"" + fileName+"\"}";
    
 $.ajax({
        type: "POST",
        url: "/diamondback/app/save/schedule",
        async: false,
        data: scheduleData,
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(){ alert("Schedule saved successfully");}, 
        failure: function(errMsg) {
            alert(errMsg);
        }
      });


}


 function populateCron(){
        
            
		            $.ajax({
		        type: "GET",
		        url: "/diamondback/app/list/cron",
		        contentType: "application/json; charset=utf-8",
		        dataType: "json",
		        success: function(fdata){processCronTable(fdata.data);}, 
		        failure: function(errMsg) {
		            alert(errMsg);
		        }
		      });  
		         
		    //setInterval(populateCron(),50000);    
		}
		var cronTable;
        
        function processCronTable(sdata){
         if(cronTable){
            cronTable.destroy();
        }
         cronTable = $('#cronTable').DataTable( {
  			aaData: sdata
            
         });
        
        }



        
        function populateSchedule(){
        
            
		            $.ajax({
		        type: "GET",
		        url: "/diamondback/app/show/schedule",
		        contentType: "application/json; charset=utf-8",
		        dataType: "json",
		        success: function(fdata){processScheduleTable(fdata.data);}, 
		        failure: function(errMsg) {
		            alert(errMsg);
		        }
		      });     
		        
		}
        
        function processScheduleTable(sdata){
         if(scheduleTable){
            scheduleTable.destroy();
        }
         scheduleTable = $('#scheduleTable').DataTable( {
  			aaData: sdata,
              "fnRowCallback": function( nRow, aData, iDisplayIndex ) {
                  
                    /* Append the grade to the default row class name */
                   if ( aData[2] == "SCHEDULED" )
                    {
                        $('td:eq(2)', nRow).html( '<b>SCHEDULED</b>' );
                    } else {
                        $('td:eq(2)', nRow).html( "<button id='sDownload'>Download!</button>" );
                    }
                }
           
         });
            
             $('#scheduleTable tbody').on( 'click', '#sDownload', function () {
        var data = scheduleTable.row( $(this).parents('tr') ).data();
        //alert(data[4]);
        location.href = "/diamondback/app/download/"+data[1]+"-"+data[0]; 
         } );
        
        }
        
        
        
        function fnclear(){
            //alert("clear");
            
          $("#hospital").val("");
        $("#workstation").val("");    
           $("#procid").val(""); 
            $("#fromdate").val("");
            $("#todate").val("");
            $("#sfprocid").val("");
            table.clear().draw();
            $('#example tbody').unbind();
            
            
        }
        
     function uploadFile(){
    
      var bar = $('.bar');
var percent = $('.percent');
var status = $('#status');
   
$('form').ajaxForm({
    beforeSend: function() {
        status.empty();
        var percentVal = '0%';
        bar.width(percentVal)
        percent.html(percentVal);
    },
    uploadProgress: function(event, position, total, percentComplete) {
        var percentVal = percentComplete + '%';
        bar.width(percentVal)
        percent.html(percentVal);
		//console.log(percentVal, position, total);
    },
    success: function() {
        var percentVal = '100%';
        bar.width(percentVal)
        percent.html(percentVal);
    },
	complete: function(xhr) {
	
	loadTable();
	
	
	
	}
}); 
  }         
  
       
        
	</script>

</head>
<body>



<div id="myTabs" class="container">
  <ul>
    <li><a href="#tabs-0">Upload zip</a></li>
    <li><a href="#tabs-1">Web Query</a></li>
    <li><a href="#tabs-2">Schedule details</a></li>
    <li><a href="#tabs-3">Job Report</a></li>
    
  </ul>
  <div id="tabs-0">
  		 <div id="uploader" class="container">
  		 </div>
  </div>
  
  
  <div id="tabs-1">
    <div class="container">
     <h2>Web Query</h2>
  <div style="white-space: nowrap;">
    <div class="form-group">
      <label for="email">Hospital:</label>
      <input type="text" class="form-control" id="hospital" style="width:20%" placeholder="Hospital">
    </div>
    <div class="form-group">
      <label for="workstation">Workstation:</label>
      <input type="text" class="form-control" id="workstation" style="width:20%" placeholder="Workstation">
    </div>
    <div class="form-group">
	      <label for="procedure_id">Procedure ID:</label>
	      <input type="text" class="form-control" id="procid" style="width:20%" placeholder="Procedure ID">
    </div>
    <div class="form-group">
	      <label for="procedure_id">Salesforce Procedure ID:</label>
	      <input type="text" class="form-control" id="sfprocid" style="width:20%" placeholder="Salesforce Procedure ID">
    </div>
    <div class="form-group">
	      <label for="datetime">From Date:</label>
	      <input type="workstation" class="form-control" id="fromdate" style="width:20%" placeholder="From Date">
    </div>
     <div class="form-group">
	      <label for="datetime">To Date:</label>
	      <input type="workstation" class="form-control" id="todate" style="width:20%" placeholder="To Date">
    </div>
    <div class="form-group">
		<button type="submit" class="btn btn-default" onclick="processSearch()">Submit</button>
        <button type="submit" class="btn btn-default" onclick="fnclear()">Clear</button>
        <button type="submit" class="btn btn-default" onclick="executeScript()">Execute Algorithm</button>

    </div>
     
      
      </div>
<div style="width:80%">
     <table id="example" class="table table-striped table-bordered" cellspacing="0">
					<thead>
						<tr>
						   
							<th>Hospital</th>
							<th>Workstation</th>
							<th>Procedure ID</th>
							<th>Date</th>
                            <th>File Name</th>
							<th>Command</th>
                           
							
						</tr>
					</thead>
					<tfoot>
						<tr>
						   
							<th>Hospital</th>
							<th>Workstation</th>
							<th>Procedure ID</th>
							<th>Date</th>
							<th>File Name</th>
                            <th>Command</th>
                           
							
						</tr>
					</tfoot>
		</table>
    </div>

     </div>
    
  </div>
  <div id="tabs-2">
     <div id="searchcontainer">
      <button type="submit" class="btn btn-default" onclick="populateSchedule()">Refresh</button>
         
       <table id="scheduleTable" class="table table-striped table-bordered" cellspacing="0">
					<thead>
						<tr>
						   
							<th>Scripts</th>
							<th>File</th>
                            <th>Status</th>
						</tr>
					</thead>
					<tfoot>
						<tr>
						   
							<th>Scripts</th>
							<th>File</th>
                            <th>Status</th>
							
						</tr>
					</tfoot>
		</table>
      
      
      </div>
  </div>
  
  
  <div id="tabs-3">
     <div id="searchcontainer">
         <button type="submit" class="btn btn-default" onclick="populateCron()">Refresh</button>
      <div width="80%">
       <table id="cronTable" class="table table-striped table-bordered"  cellspacing="0">
					<thead>
						<tr>
						   
							<th>File Name</th>
                            <th>Status</th>
						</tr>
					</thead>
					<tfoot>
						<tr>
						   
					
							<th>File Name</th>
                            <th>Status</th>
							
						</tr>
					</tfoot>
		</table>
      
      </div>
      </div>
  </div>
 
  
</div>



 
</body>
    
    <div id="dialog-form" title="Execute Script">
       
        <form action="/diamondback/app/upload" method="post" enctype="multipart/form-data">
        <input type="file" name="myfile[]" multiple><br>
        <input type="submit" value="Upload File to Server" onclick = "uploadFile(true)">
        </form>

        <div class="progress">
            <div class="bar"></div >
            <div class="percent">0%</div >
        </div>

        <div id="status"></div>
 
  <table id="scriptTable" class="table table-striped table-bordered" cellspacing="0">
					<thead>
						<tr>
						   
							<th>Scripts</th>
							<th>Command</th>
						</tr>
					</thead>
					<tfoot>
						<tr>
						   
							<th>Scripts</th>
							<th>Command</th>
							
						</tr>
					</tfoot>
		</table>
</div>

</html>